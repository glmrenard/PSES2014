<!DOCTYPE html>
<html>
  <head>
    <title>Title</title>
    <meta http-equiv="Content-Type" content="text/html; charset=UTF-8"/>
    <style type="text/css">
      @import url(http://fonts.googleapis.com/css?family=Yanone+Kaffeesatz);
      @import url(http://fonts.googleapis.com/css?family=Droid+Serif:400,700,400italic);
      @import url(http://fonts.googleapis.com/css?family=Ubuntu+Mono:400,700,400italic);

      body { font-family: 'Droid Serif'; }
      h1, h2, h3 {
        font-family: 'Yanone Kaffeesatz';
        font-weight: normal;
      }
      .remark-code, .remark-inline-code { font-family: 'Ubuntu Mono'; }

      body {
        font-family: 'Droid Serif';
      }
      h1, h2, h3 {
        font-family: 'Yanone Kaffeesatz';
        font-weight: 400;
        margin-bottom: 0;
      }
      .remark-slide-content h1 { font-size: 3em; }
      .remark-slide-content h2 { font-size: 2em; }
      .remark-slide-content h3 { font-size: 1.6em; }
      .footnote {
        position: absolute;
        bottom: 3em;
      }
      li p { line-height: 1.25em; }
      .red { color: #fa0000; }
      .blue { color: #0CA9FA; }
      .green { color: #74B73F; }
      .large { font-size: 2em; }
      a, a > code {
        color: rgb(249, 38, 114);
        text-decoration: none;
      }
      code {
        -moz-border-radius: 5px;
        -web-border-radius: 5px;
        background: #e7e8e2;
        border-radius: 5px;
      }
      .remark-code, .remark-inline-code { font-family: 'Ubuntu Mono'; }
      .remark-code-line-highlighted     { background-color: #373832; }
      .pull-left {
        float: left;
        width: 47%;
      }
      .pull-right {
        float: right;
        width: 47%;
      }
      .pull-right ~ p {
        clear: both;
      }
      #slideshow .slide .content code {
        font-size: 0.8em;
      }
      #slideshow .slide .content pre code {
        font-size: 0.9em;
        padding: 15px;
      }
      .inverse {
        background: #272822;
        color: #777872;
        text-shadow: 0 0 20px #333;
      }
      .inverse h1, .inverse h2 {
        color: #f3f3f3;
        line-height: 0.8em;
      }

      /* Slide-specific styling */
      #slide-inverse .footnote {
        bottom: 12px;
        left: 20px;
      }
      #slide-how .slides {
        font-size: 0.9em;
        position: absolute;
        top:  151px;
        right: 140px;
      }
      #slide-how .slides h3 {
        margin-top: 0.2em;
      }
      #slide-how .slides .first, #slide-how .slides .second {
        padding: 1px 20px;
        height: 90px;
        width: 120px;
        -moz-box-shadow: 0 0 10px #777;
        -webkit-box-shadow: 0 0 10px #777;
        box-shadow: 0 0 10px #777;
      }
      #slide-how .slides .first {
        background: #fff;
        position: absolute;
        top: 20%;
        left: 20%;
        z-index: 1;
      }
      #slide-how .slides .second {
        position: relative;
        background: #fff;
        z-index: 0;
      }

      /* Two-column layout */
      .left-column {
        color: #777;
        width: 20%;
        height: 92%;
        float: left;
      }
        .left-column h2:last-of-type, .left-column h3:last-child {
          color: #000;
        }
      .right-column {
        width: 75%;
        float: right;
        padding-top: 1em;
      }
    </style>
  </head>
  <body>
    <textarea id="source">

name: inverse
layout: true
class: center, middle, inverse

.footnote[
  PSES 2014
]

---
# ELK
## Elasticsearch, Logstash, Kibana

<br/><br/>
Pas Sage en Seine 2014
---
name: bio
layout: false
class: center

.footnote[
  PSES 2014
]

## Jean Baptiste Favre

<br/><br/>

### Architecte système &amp; réseau .green[Bla] .blue[Bla] .red[Car]

<br/><br/>

Twitter: [@jbfavre](https://www.twitter.com/jbfavre)

GitHub:  [jbfavre](https://www.github.com/jbfavre)

GnuSocial: [https://status.jbfavre.org/](https://status.jbfavre.org/)


---
name: classic
layout: false

.footnote[
  PSES 2014
]

.left-column[
 ## Agenda
]

.right-column[

<br/>

### Analyse "d'évènements"

### L'incroyable .green[ELK] .red[*]

- Ce que c'est

- Comment ça marche

### Démo

### Autres utilisations

.footnote[.red[*] Je sais, elle était facile...]

]

---
template: inverse

# Analyse de logs
## et autres évènements

---
layout:false

.footnote[
  PSES 2014
]

.center[
## Peu de logs

![moine copiste](img/moine_copiste.jpg)
]

---
layout:false


.footnote[
  PSES 2014
]

.center[
## Beaucoup de logs

![moine copiste](img/bcp_de_serveurs.jpg)
]

---
layout:false


.footnote[
  PSES 2014
]

.center[
## Trop de logs

![moine copiste](img/trop_de_serveurs.jpg)
]

---
layout: false

.footnote[
  PSES 2014
]

.center[
## Une solution

![Kibana 1](img/kibana1.png)

]

---
layout: false

.footnote[
  PSES 2014
]

.center[
## Parmis d'autres

![Kibana 2](img/kibana2.png)
]

---
template: inverse

# ELK, c'est quoi ?

---
layout: false

.footnote[
  PSES 2014
]

.left-column[
 ## C'est quoi ?
 ### ES
]

.right-column[

* moteur d'indexation

  - utilise Lucene

* NoSQL

  - documents sans schema
  - mais les champs peuvent être typés
  - stockage dans un index
      * shards, réplicats

* fonctionnement

  - en cluster

  - passage à l'échelle .red[facile]

* API REST HTTP/JSON

]

---
.footnote[
  PSES 2014
]

.left-column[
 ## C'est quoi ?
 ### ES
 ### Logstash
]

.right-column[

* aggrégateur de logs

  - log = horodatage + message

* multiformat

  - Codecs

  - Filtres

* Greffons d'entrée &amp; sortie

  - Fichiers

  - Flux TCP ou UDP
      * syslog

  - Elasticsearch

]

---
.footnote[
  PSES 2014
]

.left-column[
 ## C'est quoi ?
 ### ES
 ### Logstash
 ### Kibana
]

.right-column[

* Interface pour Elasticsearch

  - simplifie l'analyse de données

* Visualisation des données

  - cartes géographiques, histogrammes

  - graphes en points, tableaux

]

---
template: inverse

# Comment ça marche ?

---
layout: false

.footnote[
  PSES 2014
]

.center[
## Indexeur

![Architecture basique](img/logstash-elasticsearch-kibana.png)

<br/>

## Shipper + Indexeur

![Architecture avancée](img/logstash-redis-elasticsearch-kibana.png)

]

---
layout: false

### Configuration Elasticsearch

* ```/etc/elasticsearch/elasticsearch.yml```

  - cluster.name
  - node.name
  - index.number_of_shards
  - index.number_of_replicas
  - network.host

* curl http://127.0.0.1:9200/

```javascript
{
  "status" : 200,
  "name" : "pses2014-1",
  "version" : {
    "number" : "1.0.3",
    "build_hash" : "61bfb72d845a59a58cd9910e47515665f6478a5c",
    "build_timestamp" : "2014-04-16T14:43:11Z",
    "build_snapshot" : false,
    "lucene_version" : "4.6"
  },
  "tagline" : "You Know, for Search"
}
```
---
layout: false

### Plugins Elasticsearch

* head / kopf: admin

* marvel (payant): monitoring

* Redis, memcached: transport

* Hadoop, S3: snapshot/restore

http://www.elasticsearch.org/guide/en/elasticsearch/reference/current/modules-plugins.html

---
layout: false

### Configuration Input Logstash


* ```/etc/logstash/conf.d/twitter.conf```

```javascript
input{
}
```

* Fichier local

```javascript
    file {
        path => "/var/log/apache2/*access.log"
        tags => ["apache"]
    }
```

* Recherche Twitter

```javascript
    twitter {
        consumer_key       => "XXXXXX"
        consumer_secret    => "XXXXXXXXXXXXXXX"
        keywords           => ["pses", "pses2014"]
        oauth_token        => "XXXXXXXX-YYYYYYYY"
        oauth_token_secret => "XXXXXXXXXXXXXXXXX"
        full_tweet         => true
        tags               => ["pses2014"]
    }
```
---
layout: false

.footnote[
  PSES 2014
]

### Configuration Filter Logstash

* ```/etc/logstash/conf.d/twitter.conf```

```javascript
filter{
}
```
* Enrichir ou modifier l'évènement
    * geoip
    * dns

```javascript
geoip {
  source   => "ip_addr"
  fields   => [ "country_code2" ]
  database => "/usr/share/GeoIP/GeoIP.dat"
}
```

* Reconstituer un évènement
    * multiline

---
layout: false

.footnote[
  PSES 2014
]

### Configuration Filter Logstash

* ```/etc/logstash/conf.d/twitter.conf```

```javascript
filter{
}
```
* Décortiquer un log

```javascript
    if "apache" in [tags] {
        grok {
            pattern => "%{COMBINEDAPACHELOG}"
        }
    }
```

=> ```/opt/logstash/patterns/grok-patterns```

```javascript
COMBINEDAPACHELOG %{COMMONAPACHELOG} %{QS:referrer} %{QS:agent}
COMMONAPACHELOG %{IPORHOST:clientip} %{USER:ident} %{USER:auth} \
                \[%{HTTPDATE:timestamp}\] \
                "(?:%{WORD:verb} %{NOTSPACE:request}(?: HTTP/%{NUMBER:httpversion})? \
                |%{DATA:rawrequest})" %{NUMBER:response} (?:%{NUMBER:bytes}|-)
```
---
layout: false

.footnote[
  PSES 2014
]

### Filtre Grok personnalisé

Log brut:  
```Failed password for root from 192.168.42.42 port 45528 ssh2```

Informations:  
* Login       => ```root```
* Adresse IP  => ```192.168.42.42```
* Port source => ```45528```

Pattern

```javascript
"Failed password for %{WORD:login} from %{IP:ip_source} port %{NUMBER:port_source} ssh2"
```

Filtre

```javascript
grok {
    pattern => "Failed password for %{WORD:login} from %{IP:ip_source} port %{NUMBER:port_source} ssh2"
    tags    => ["ssh_bruteforce"]
}
```

---
layout: false

### Configuration Output Logstash

* ```/etc/logstash/conf.d/twitter.conf```

```javascript
output{
}
```

* Elasticsearch

```javascript
if "apache" in [tags] {
    elasticsearch_http {
        host     => "127.0.0.1"
        port     => 9200
        index    => "apachelogs-%{+YYYY.MM.dd}"
        template => "/etc/logstash/apache.template"
    }
}
if "pses2014" in [tags] {
    elasticsearch_http {
        host     => "127.0.0.1"
        port     => 9200
        index    => "pses2014-%{+YYYY.MM.dd}"
        template => "/etc/logstash/pses2014.template"
    }
}

```

---
layout: false

.footnote[
  PSES 2014
]

### Configuration Template Logstash

* ```/etc/logstash/pses2014.template```

```javascript
{
  "template": "pses2014-*",
  "settings" : {
    "number_of_shards" : 4,
    "number_of_replicas" : 0,
    "index" : {
      "query" : { "default_field" : "@message" },
      "store" : { "compress" : { "stored" : true } },
      "cache" : { "field_type" : "soft" }
    }
  },

[...]

}
```

---
layout: false

.footnote[
  PSES 2014
]


### Configuration Template Logstash

* ```etc/logstash/pses2014.template```

```javascript
{
[...]
  "mappings": {
    "tweet": {
      "_all": { "enabled": false },
      "_source": { "compress": true },
      "properties" : {
        "@fields": { "type": "object", "dynamic": true },
        "@message" : { "type" : "string", "index" : "analyzed" },
        "@source" : { "type" : "string", "index" : "not_analyzed" },
        "@source_host" : { "type" : "string", "index" : "not_analyzed" },
        "@source_path" : { "type" : "string", "index" : "not_analyzed" },
        "@tags": { "type": "string", "index" : "not_analyzed" },
        "@timestamp" : { "type" : "date", "index" : "not_analyzed" },
        "@type" : { "type" : "string", "index" : "not_analyzed" }
      }
    }
  }
}
```

---
layout: false

.footnote[
  PSES 2014
]

### Mapping Elasticsearch

* Permet de typer les champs

    * Optimiser l'indexation par Lucène
        * n'indexer que ce que l'on veut
    * Réaliser des opérations particulières (tri par exemple)

* Exemples

    * Adresses IP
    * Dates + heure
    * Positions géographiques    

<br/><br/>

http://www.elasticsearch.org/guide/en/elasticsearch/reference/current/mapping-types.html

---
layout: false

.footnote[
  PSES 2014
]

### Installation Kibana

* http://download.elasticsearch.org/kibana/kibana/kibana-latest.zip

* ```/var/www/kibana/config.js```, champ ```elasticsearch```

* ```/etc/nginx/site-availables/pses.conf```

```javascript
upstream es_backend {
    server 127.0.0.1:9200;
    keepalive 64;
}
server {
  listen       80;
  server_name  pses2014.jbfav.re;
  client_max_body_size 50m;
  root /var/www/kibana;
  try_files $uri $uri/ index.html @elasticsearch;

[...]

}
```

---
layout: false

.footnote[
  PSES 2014
]

### Installation Kibana

* /etc/nginx/site-availables/pses.conf

```javascript
  location @elasticsearch {
    proxy_pass http://es_backend;
    proxy_read_timeout 90;
    proxy_redirect off;
    proxy_http_version 1.1;

    proxy_set_header Connection "";
    proxy_set_header  X-Real-IP  $remote_addr;
    proxy_set_header  X-Forwarded-For $proxy_add_x_forwarded_for;
    proxy_set_header  Host $http_host;

    proxy_pass_header Access-Control-Allow-Origin;
    proxy_pass_header Access-Control-Allow-Methods;
    proxy_hide_header Access-Control-Allow-Headers;
    
    add_header Access-Control-Allow-Headers 'X-Requested-With, Content-Type';
    add_header Access-Control-Allow-Credentials true;
  }
```
---
template: inverse

# Démo

---
template: inverse

# Autres applications

---
layout: false

.footnote[
  PSES 2014
]

.center[
## Application Performance management

![PacketBeat](img/PacketBeat.png)

http://packetbeat.com/

]

---
layout: false

.footnote[
  PSES 2014
]

.center[
## Securité

![Suricata](img/Suricata.png)

https://home.regit.org/tag/suricata/

]

---
layout: false

.footnote[
  PSES 2014
]

.center[
## Activité métier

![BlaBlaCar](img/BlaBlaCar-métier.png)

.green[Bla] .blue[Bla] .red[Car]

]

    </textarea>
    <script src="http://gnab.github.io/remark/downloads/remark-latest.min.js" type="text/javascript">
    </script>
    <script type="text/javascript">
      var slideshow = remark.create();
    </script>
  </body>
</html>

